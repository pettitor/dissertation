\section{Analysis of Caching Systems with Bandwidth Constraints}\label{sec:hierarchical:analyticbw:model}

To evaluate content delivery networks based on the number of available home routers and their limited capacity, we define a system model for a tiered caching architecture.
Tier-1 caches are on leaf nodes such as home routers, caches of the content delivery network are in tier-2 and ultimately tier-3 is the content provider.
We use analytic models to calculate the efficiency of the tiered caching architecture.



%\subsection{Performance Metrics}

%\begin{itemize}
%	\item hit rate, define as hit on device WITH enough available bandwidth / resources
%	\item effective cache capacity
%  \item ...
%\end{itemize}

%To be able to estimate the costs for ASes arising from transit services, we need to know how much traffic is generated and how much providers charge customers for forwarding the traffic.
%We consider a snapshot and assume instantaneous traffic rates, i.e., the file-size of the download can be neglected.
%For simplicity we make assumptions on how much traffic is generated in each swarm, depending on the the number and location of peers.
%\newtheorem{A}{Assumption}\begin{A}\label{npeers}
%The traffic generated by a peer is equally shared among its neighbors.
%\end{A}
%\newtheorem{B}[A]{Assumption}\begin{B}\label{ntraffic}
%All peers generate traffic at the same rate.
%\end{B}
%\newtheorem{C}[A]{Assumption}\begin{C}\label{npaths}
%The traffic between ASes is equally shared among the paths that connect them.
%\end{C}
%In practice traffic rates are allocated by BitTorrent's choking algorithm and traffic is generally not shared among different AS paths. But, since we consider the aggregated traffic of a large number of swarms, we argue that these assumptions are reasonable and that the results are not changed significantly.

\subsection{Analytic Performance Models for Caching Systems}

In the following we provide analytic models to evaluate the performance of a tiered caching architecture.
We use existing models for systems without bandwidth constraints in order to determine baselines and upper bounds for comparison.
We then show our approach to determine the hit rate of hierarchical cache networks with bandwidth constraints.

\subsubsection{The Che-approximation}

We first consider the Che-approximation \cite{che2002hierarchical} for the simple case of a single cache with LRU policy.
Let $C$ be the capacity of the single cache.
$T_C(m)$ is the cache eviction time of object $m$, i.e., the time needed before $C$ objects, not including $m$, are requested at the cache.
Object $m$ is in the cache if the last request for object $m$ is less than $T_C$ in the past.
For Poisson arrivals, the probability that an object $m$ is in the cache equals the probability that the inter-request time for object $m$ is smaller than $T_C$.
Let $A_m$ be a random variable for the inter-arrival time for requests of object $m$.
The probability that $A_m$ is smaller than $T_C$ is given by the cumulative distribution function, which is exponentially distributed:

\begin{equation}
	p_\text{hit}(m) = p_\text{in}(m) = P(A_m \leq T_C) = 1-e^{-\lambda_m T_C} \, .
\end{equation}

Due to the memoryless property of the Poisson process the hit probability equals the stationary probability that an item $m$ is in the cache.

We define the indicator function $\chi_m$ to determine if item $m$ is in the cache.

\begin{equation}
\chi_m =
	\begin{cases}
		1, & m \, \text{in cache} \, ,\\
      		0, & \text{otherwise} \, .
	\end{cases}
\end{equation}

Following \cite{martina2014unified}, we obtain for the cache capacity $C$:

\begin{equation}
	C=\sum_m{\chi_m} \, ,
\end{equation}

and

\begin{equation}
	C=\mathbb{E}\left[\sum_m{\chi_m}\right]=\sum_m{\mathbb{E}\left[\chi_m\right]}=\sum_m{p_\text{in}(m)} \, .
\end{equation}

after averaging both sides.

$T_C$ is the only unknown in the above equation and can be determined by a fixed point iteration.
Thus, the interaction among the contents is summarized by the cache eviction time $T_C$, which allows decoupling the dynamics of the different contents.

The overall hit probability is calculated by considering the probability $p_m$ of requesting item $m$

\begin{equation}
p_\text{hit}=\sum_m p_m p_\text{hit}(m) \, .
\end{equation}

\subsubsection{No bandwidth constraints}

We use the Che-approximation for the LRU cache hit rate to calculate the baseline given by the cache hit rate of the tier-2 cache without tier-1 cache support $p'_\text{hit}(2)$. The characteristic time $T_{C_2}$ depends on the capacity of the tier-2 cache $C_2$ and is determined by a fixed point approximation

\begin{equation}
p_\text{hit}(2,m)=p_\text{in}(2,m)=1-e^{-\lambda_{m}T_{C_2}} \, .
\end{equation}

The overall hit probability in tier-2 is calculated by considering the probability $p_m$ of requesting item $m$

\begin{equation}
p'_\text{hit}(2)=\sum_m p_m p_\text{hit}(2,m) \, .
\end{equation}
%\begin{equation}
%p_m=\frac{\lambda_m}{\sum_i \lambda_i}
%\end{equation}

To calculate the maximum hit rate for LRU, we assume that tier-1 caches are completely organized with the tier-2 cache, and the capacity of tier-1 caches is added to the tier-2 cache capacity

\begin{equation}
\hat p_\text{hit}(m)=\hat p_\text{in}(m)=1-e^{-\lambda_{m}T_{(C_2+n_1\cdot C_{1})}} \, .
\end{equation}

It is practically not feasible to control the capacity of all tier-1 caches and coordinate them with the tier-2 cache.
To still bundle the capacity of the tier-2 caches, the caches can form an overlay.

%The probability to find object $m$ in a tier-2 cache is $p_{in}(2,m)$.

%TODO tree case.

%\begin{equation}
%p_\text{hit}(2,m)=p_{in}(2,m)=1-e^{-\lambda_{m}T_{C_2}}
%\end{equation}

If an overlay is used, the requests that cannot be served by the personal tier-1 cache are forwarded to other tier-1 caches in the overlay, before they are forwarded to the tier-2 cache.
%The requests that are forwarded to the tier-1 cache have looked up the object $m$ in all tier-2 caches.
%The requests for object $m$ forwarded to tier-1 $\lambda_m^o(1)$ are not hit by any of the $n_2\approx p_{share}\cdot n_{user}$ tier-2 caches.

We approximate the hit rate of the overlay by calculating the hit rate of a tandem network with two caches according to \cite{martina2014unified}. The tandem network consists of the tier-2 cache and a cache that has the sum of capacities of tier-1 caches. The miss stream of the consolidated tier-1 cache is forwarded to the tier-2 cache.
The replacement strategy in the network is leave-copy-down, that means that an item is only placed in a cache if it is found in a higher tier cache. Thus only frequently requested items are propagated to lower tier-caches, which makes them more efficient. The Che-approximation can be applied to tandem networks by determining $p_\text{in}(1,m)$ for the tier-1 caches

\begin{equation}
p_\text{in}(1,m) = 1-e^{\lambda(1,m)T_{n_1 C_1}} \, .
\end{equation}

The hit probability is no longer equal to the probability that an item is in the cache, as the cache miss stream arriving at the tier-2 cache is no longer Markov. According to \cite{martina2014unified} the hit probability can then be determined by:

\begin{multline}
p_\text{hit}(1,m) = ((1-p_\text{in}(1,m))p_\text{hit}(2,m) + p_\text{in}(1,m)) \\ \cdot(1-e^{\lambda(1,m)T_{n_1 C_1}}) \, .
\end{multline}

The rate of the miss stream $\lambda(2,m)$ arriving at the tier-2 cache can then be determined as

\begin{equation}
\lambda(2,m) = (1-p_\text{in}(1,m))\lambda(1,m) \, .
\end{equation}

The probability that an item is in the tier-2 cache is approximated assuming exponentially distributed inter request times

\begin{equation}
p_\text{hit}(2,m) = p_\text{in}(2,m) = 1-e^{\lambda(2,m)T_{C_2}} \, .
\end{equation}

The total hit rate in tier-$i$ is then calculated by considering the probability of an item $m$ being requested at tier-$i$ cache $p(i,m)$

\begin{equation}
p_\text{hit}(i) = \sum_{m}p(i,m)p_\text{hit}(i,m), i\in\{1,2\} \, .
\end{equation}
%if tC(2) > tC(1)
%   phit(2,:) = (1-exp(-l(2,:).*(tC(2)-tC(1))))+(1-phit(2,:)).*(1-exp(-l(1,:)*tC(1)));
%else
%   phit(2,:) = (1-phit(2,:)).*(1-exp(-l(1,:)*tC(2)));
%end

% wrong
%\begin{equation}
%\lambda_m^o(1)=\lambda_m\cdot(1-p_\text{hit}(2,m))^{n_2}
%\end{equation}

%The hit rate of the object $m$ in tier-1 cache in the overlay case $p_\text{hit}^{o}(1,m)$ can be approximated according to \cite{â€¢}.

%\begin{equation}
%p_\text{hit}^{o}(1,m) \approx 1-e^{A_1^o(m)}
%\end{equation}

%where (TODO improve)
%\begin{align*}
%A_1^o(m)&=\frac 1 {n_2}\cdot \lambda_m\cdot (1-p_{in}(2,m))^{n_2}\cdot max(0,T_{C_1}-T_{C_2}) + \\ &\frac {n_2-1}{n_2}\cdot \lambda_m\cdot(1-p_{in}(2,m))^{n_2}\cdot T_{C_1}
%\end{align*}

%The hit rate of the tier-2 overlay caches $p_\text{hit}^{o}(2,m)$ is the probability of the event complementary to no tier-2 cache hit.

%\begin{equation}
%p_\text{hit}^{o}(2,m) = \lambda_m\cdot (1-(1-p_{in}(2,m))^{n_2})
%\end{equation}

The overall hit rate of the hierarchical caching system is then calculated by

\begin{equation}
\bar{p}_\text{hit} = p_\text{hit}(1)+(1-p_\text{hit}(1))p_\text{hit}(2) \, .
\end{equation}

%with $p_m=\frac{\lambda_m}{\sum_i \lambda_i}$.

\subsection{Analytic Model with Bandwidth Constraints}

The above hit rates only apply if tier-1 and tier-2 caches have unlimited bandwidth, which is practically not feasible.
Considering the home router scenario, the bandwidth of tier-1 caches is limited depending on the subscription and the availability of DSL.
We use the throughput of the tier-1 caches $\rho_1$ as parameter to specify the upload bandwidth available on home routers.

%\begin{equation}
%\bar b = \frac 1 N \sum_{m=1}^N b_m
%\end{equation}

%\begin{equation}
%\bar \rho_1 = \frac 1 {n_1} \sum_{i=1}^{n_1} \rho_1(i)
%\end{equation}

%\begin{equation}
%\bar\mu = \frac{\bar b}{\bar \rho_2}
%\end{equation}

The offered traffic of item $m$ at tier-1 cache $k$ can be calculated by the quotient of the arrival rate per cache $\frac{\lambda_m}{n_1}$ and the mean service rate, which is determined by the bitrate $b_m$ and the duration $d_m$ and the link throughput $\rho_1$ in case of video contents

\begin{equation}
a(m,k) = \frac{\lambda_m \cdot b_m \cdot d_m}{n_1\cdot \rho_1(k)} \, .
\end{equation}

The total offered traffic of item $m$ is $a(m) = \sum_k a(m,k)$.

%\begin{equation}
%a(m) = \sum_k a(m,k) \, .
%\end{equation}

The content placement in tier-1 is specified by $X: N \times n_1\mapsto \{0,1\}, X(m,k) = 1$, if content $m$ is placed at cache $k$, else $0$.

According to \cite{valancius2009greening} an optimal placement of items in terms of minimum loss rate in the stationary case is achieved by the hot-warm-cold content placement.
Hot content with $a(m)\geq n_1$ is placed on each cache.
Warm content is placed on $\lfloor a(m) \rfloor$ caches.
Cold content is not placed on any of the caches.
The constraint  $\forall k, \sum_m X(m,k)\leq C_1(k)$ has to be met, such that the cache capacities are not exceeded.
%hotwarmcold: while $\forall k, \sum_m X(m,k)\leq C_1(k)$
%\begin{itemize}
%	\item $\forall k, X(m,k)=1, \text{if}\ a(m) \geq \sum_k C_1(k) $
%	\item $\forall i, X(m,k)=1, i$ not occ TODO
%\end{itemize}

% We define the indicator function $\chi_m$ to determine if item $m$ is cached.
%
% \begin{equation}
% \chi_m =
% 	\begin{cases}
% 		1, & \exists k : X(m,k)=1 \\
%       		0, & \text{otherwise}
% 	\end{cases}
% \end{equation}

%The hit rate of the placement can be calculated by
%%TODO correct?
%\begin{equation}
%	p_\text{hit}^\text{hwc}(2,m) = \chi_m \cdot (1-\max(0,\frac{a(m)}{n_2}-1))
%\end{equation}

%and

%\begin{equation}
%	p_\text{hit}^\text{hwc}(2) = p_\text{hit}^\text{hwc}(2,m) \cdot p_m \, .
%\end{equation}

%TODO leave out
% The effective cache size of tier-1 $C_1^*$ is defined as the number of different items that is stored in tier-1 caches. It is calculated by
%
% \begin{equation}
% C_1^* = \sum_m \chi_m \, .
% \end{equation}

Since not every hit can be served by tier-1 caches because of their limited bandwidth, we consider the loss rate $p_{b}(1,m)$, which is defined as the share of requests of item $m$ that is not hit in tier-1 or is blocked if none of the tier-1 caches storing the requested item has enough bandwidth left to serve the request.

Let $\nu_m$ be the number of tier-1 caches that hold item $m$

\begin{equation}
\nu_m=\sum_{k=1}^{n_1} X(m,k) \, .
\end{equation}

%An item is not hit, if it is not placed in any of the tier-1, hence, if $X(m,k)=0 \forall k\in {1,\ldots,n_1}$.
An item is not hit, if it is not placed in any tier-1 cache, i.e., if $\nu_m=0$.
If an item is placed in at least one of the tier-1 caches, i.e., $\nu_m>0$, we approximate the blocking probability by the Erlang formula for a loss system with $\nu_m$ servers with mean service rate $\mu_{m} = \frac{\rho_1}{b_m\cdot d_m}$ and arrival rate $C_1\lambda_m$:


\begin{equation}
p_{b}(1,m) =
	\begin{cases}
		\frac{\frac{a_m^{\nu_m}}{m!}}{\sum_{k=0}^{\nu_m}\frac{a_m^k}{k!}}, & \nu_m>0 \\
    1, & \text{otherwise} \, ,
	\end{cases}
\end{equation}

where we approximate the offer of item $m$ with
\begin{equation}
a_m \approx \frac{\lambda_m\cdot C_1}{\mu_m} \, .
\end{equation}
Note, that here we assume that the arrival rate of requests of the $C_1$ items stored in the cache is equal to the rate of item $m$.
In order to calculate the exact stationary distribution of the blocking probability, the arrival rate of requests has to be conditioned on the feasibility of the content placement, which is too complex to evaluate.
Refer to \cite{tan2013optimal} for details.
%We also tried other arrival rates, such as average arrival rate of the items cached, which did not improve the approximation.

The blocked requests are forwarded to the tier-2 cache and the arrival rate of requests of item $m$ at the tier-2 cache can be determined as

\begin{equation}
	\lambda_m(2) = \lambda_m\cdot p_\text{b}(1,m) \, .
\end{equation}

We determine the hit rate of the tier-2 cache $p_\text{hit}(2)$ again by using the Che-approximation for cache capacity $C_2$ and arrival rates $\lambda_m(2)$, assuming that the miss stream of the tier-1 caches follows a Poisson process

%TODO describe
\begin{equation}
	p_b(1) = \sum_m p_m p_{b}(1,m) \, .
\end{equation}

The total rate of requests hit and served by tier-1 and tier-2 caches is then determined by

\begin{equation}
	p_\text{hit} = (1-p_b(1)) + p_b(1)\cdot p_\text{hit}(2) \, .
\end{equation}

In order to assess the benefit of the tiered architecture compared to a single ISP cache, we define the cache hit rate gain $\omega$ as the normalized difference of the total hit rate $p_\text{hit}$ and the cache hit rate of the tier-2 cache $p'_\text{hit}(2)$ without tier-1 cache support

\begin{equation}
\omega = \frac{p_\text{hit}-p'_\text{hit}(2)}{p'_\text{hit}(2)} \, .
\end{equation}

%\begin{equation}
%X_{m,k} =
%	\begin{cases}
%		0, & \text{if}\ a()=1 \\
%      		1, & \text{otherwise}
%	\end{cases}
%\end{equation}
%\begin{equation}
%r\leq C_2 n_{user} p_{share}
%\end{equation}
%\begin{equation}
%X\leq C_2 n_{user} p_{share}
%\end{equation}

%effective capacity of hot warm cold overlay -> che approximation two tiered LCD.
%Metric efficiency gain hit rate / hitrateLRU(C1)
